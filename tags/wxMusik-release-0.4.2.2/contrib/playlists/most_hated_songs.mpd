FROM (select songid,sum(weight/(timesplayed+1)) as w from (select distinct songid as sid,-rating * 3 as weight from songs where rating < 0 union all select songid as sid,count(*) as weight from songhistory where percent_played < 33 group by songhistory.songid union all select songid as sid,-sum(selected_by_user) as weight from songhistory group by songhistory.songid) left join songs on songid=sid group by songid having w > 0  order by w desc)  limit 100
