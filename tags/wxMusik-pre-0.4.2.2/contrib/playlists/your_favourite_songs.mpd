FROM (select songid,sum(weight) as w from (select distinct songid as sid, rating as weight from songs where rating >=0   union all select songid as sid,sum(selected_by_user *  (1 -  (julianday('now') - date_played) /( julianday('now')-  julianday('2000-08-11') ) ))  as weight from songhistory where percent_played > 33 group by songhistory.songid) left join songs on songid=sid group by songid having w > 0  order by w desc)  limit 100
